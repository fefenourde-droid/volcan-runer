<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Volcan Runner - Version PC</title>
<style>
  body {
    margin: 0;
    background: #050308;
    color: #fff;
    font-family: Arial, sans-serif;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #ui {
    margin-top: 4px;
    font-size: 14px;
  }
  canvas {
    border: 2px solid #ff8800;
    margin-top: 4px;
    background: #000;
  }
  .btn {
    background: #ff6600;
    border: none;
    color: #fff;
    padding: 4px 8px;
    margin: 0 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .btn:active {
    transform: scale(0.96);
  }
</style>
</head>
<body>
<div id="ui">
  <button class="btn" id="prev">◀</button>
  <span id="info">Volcan Runner PC – Niveau 1</span>
  <button class="btn" id="next">▶</button>
</div>
<canvas id="game" width="1024" height="576"></canvas>

<script>
// ==================
// CONFIG & CONTEXT
// ==================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");

const W = canvas.width;
const H = canvas.height;

const GRAVITY = 0.6;
const MOVE_SPEED = 5.2;
const JUMP_FORCE = -13;
const FRICTION = 0.85;
const MAX_FALL = 20;

let keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// ==================
// PLAYER
// ==================
let player = {
  x: 120,
  y: 0,
  w: 32,
  h: 48,
  vx: 0,
  vy: 0,
  onGround: false,
  dead: false,
  facing: 1,
  animTime: 0
};

// ==================
// LEVEL STRUCTURE
// ==================
let levels = [];
let currentLevel = 0;
let transition = {
  active: false,
  alpha: 0,
  dir: 1,
  callback: null
};

function addLevel(def) {
  levels.push(def);
}

function aabb(ax, ay, aw, ah, bx, by, bw, bh) {
  return ax < bx + bw &&
         ax + aw > bx &&
         ay < by + bh &&
         ay + ah > by;
}

// Particules de lave
let particles = [];

function spawnLavaParticle(x, y) {
  particles.push({
    x,
    y,
    vx: (Math.random() - 0.5) * 2,
    vy: -Math.random() * 2 - 1,
    life: 30 + Math.random() * 20
  });
}

// ==================
// LOAD LEVEL
// ==================
function loadLevel(index) {
  if (index < 0) index = 0;
  if (index >= levels.length) index = levels.length - 1;
  currentLevel = index;
  const lvl = levels[currentLevel];
  player.x = lvl.start.x;
  player.y = lvl.start.y;
  player.vx = 0;
  player.vy = 0;
  player.onGround = false;
  player.dead = false;
  particles = [];
  info.textContent = `Volcan Runner PC – Niveau ${currentLevel + 1}/${levels.length}`;
}

// ==================
// COLLISIONS
// ==================
function collideAxis(p, rects, axis) {
  for (const r of rects) {
    if (aabb(p.x, p.y, p.w, p.h, r.x, r.y, r.w, r.h)) {
      if (axis === "x") {
        if (p.vx > 0) p.x = r.x - p.w;
        else if (p.vx < 0) p.x = r.x + r.w;
        p.vx = 0;
      } else {
        if (p.vy > 0) {
          p.y = r.y - p.h;
          p.vy = 0;
          p.onGround = true;
        } else if (p.vy < 0) {
          p.y = r.y + r.h;
          p.vy = 0;
        }
      }
    }
  }
}

// ==================
// UPDATE
// ==================
function update() {
  if (transition.active) {
    transition.alpha += 0.06 * transition.dir;
    if (transition.dir > 0 && transition.alpha >= 1) {
      transition.alpha = 1;
      transition.dir = -1;
      if (transition.callback) transition.callback();
    } else if (transition.dir < 0 && transition.alpha <= 0) {
      transition.alpha = 0;
      transition.active = false;
    }
  }

  const lvl = levels[currentLevel];

  // plateformes mobiles
  for (const m of lvl.mobiles) {
    m.t += m.speed;
    const s = Math.sin(m.t);
    if (m.axis === "x") {
      m.x = m.baseX + s * m.range;
    } else {
      m.y = m.baseY + s * m.range;
    }
  }

  // Input
  let inputX = 0;
  if (keys["ArrowLeft"] || keys["a"]) inputX -= 1;
  if (keys["ArrowRight"] || keys["d"]) inputX += 1;

  player.vx += inputX * 1.4;
  player.vx *= FRICTION;
  if (player.vx > MOVE_SPEED) player.vx = MOVE_SPEED;
  if (player.vx < -MOVE_SPEED) player.vx = -MOVE_SPEED;

  if (inputX !== 0) {
    player.facing = inputX;
  }

  if ((keys["ArrowUp"] || keys["w"] || keys[" "]) && player.onGround) {
    player.vy = JUMP_FORCE;
    player.onGround = false;
  }

  player.vy += GRAVITY;
  if (player.vy > MAX_FALL) player.vy = MAX_FALL;

  // Déplacement & collision
  player.x += player.vx;
  player.onGround = false;
  collideAxis(player, lvl.platforms.concat(lvl.mobiles), "x");

  player.y += player.vy;
  collideAxis(player, lvl.platforms.concat(lvl.mobiles), "y");

  // Dangers
  let died = false;
  for (const d of lvl.dangers) {
    if (aabb(player.x, player.y, player.w, player.h, d.x, d.y, d.w, d.h)) {
      died = true;
      break;
    }
  }
  for (const l of lvl.lava) {
    if (aabb(player.x, player.y, player.w, player.h, l.x, l.y, l.w, l.h)) {
      died = true;
      break;
    }
    // particules de lave
    if (Math.random() < 0.3) {
      const px = l.x + Math.random() * l.w;
      const py = l.y;
      spawnLavaParticle(px, py);
    }
  }

  if (died && !player.dead) {
    player.dead = true;
    startTransition(() => {
      loadLevel(currentLevel);
    });
  }

  // Goal
  const g = lvl.goal;
  if (aabb(player.x, player.y, player.w, player.h, g.x, g.y, g.w, g.h)) {
    if (currentLevel < levels.length - 1) {
      startTransition(() => {
        loadLevel(currentLevel + 1);
      });
    } else {
      info.textContent = "Tu as dompté le volcan, GG.";
    }
  }

  // Particules update
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.life--;
    if (p.life <= 0) particles.splice(i, 1);
  }

  player.animTime += Math.abs(player.vx) * 0.05 + (player.onGround ? 0.02 : 0.05);
}

// ==================
// TRANSITION
// ==================
function startTransition(cb) {
  transition.active = true;
  transition.alpha = 0;
  transition.dir = 1;
  transition.callback = cb;
}

// ==================
// DRAW
// ==================
function drawBackground(lvl, camX) {
  // Parallax: 3 couches
  ctx.fillStyle = "#050308";
  ctx.fillRect(0, 0, W, H);

  // Couche montagnes lointaines
  ctx.save();
  ctx.translate(-camX * 0.2, 0);
  ctx.fillStyle = "#140814";
  for (let i = -1; i < 6; i++) {
    const baseX = i * 400;
    ctx.beginPath();
    ctx.moveTo(baseX, H);
    ctx.lineTo(baseX + 200, H - 180);
    ctx.lineTo(baseX + 400, H);
    ctx.closePath();
    ctx.fill();
  }
  ctx.restore();

  // Coulées de lave lointaines
  ctx.save();
  ctx.translate(-camX * 0.4, 0);
  ctx.strokeStyle = "#ff2200";
  ctx.lineWidth = 3;
  for (let i = -1; i < 6; i++) {
    const x = i * 260 + (Math.sin(Date.now() * 0.001 + i) * 40);
    ctx.beginPath();
    ctx.moveTo(x, H - 220);
    ctx.lineTo(x + 10, H);
    ctx.stroke();
  }
  ctx.restore();

  // Fumée / nuages rouges
  ctx.save();
  ctx.translate(-camX * 0.1, 0);
  for (let i = 0; i < 10; i++) {
    const x = (i * 150 + Date.now() * 0.02) % (W + 200) - 100;
    const y = 60 + Math.sin(i * 1.3 + Date.now() * 0.001) * 10;
    const r = 60 + (i % 3) * 15;
    const grad = ctx.createRadialGradient(x, y, 0, x, y, r);
    grad.addColorStop(0, "rgba(255,80,40,0.32)");
    grad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();
}

function draw() {
  const lvl = levels[currentLevel];

  // Caméra centrée sur le joueur
  const camX = Math.max(0, player.x - W * 0.5);

  drawBackground(lvl, camX);

  ctx.save();
  ctx.translate(-camX, 0);

  // plateformes
  for (const p of lvl.platforms) {
    const grad = ctx.createLinearGradient(p.x, p.y, p.x, p.y + p.h);
    grad.addColorStop(0, "#442015");
    grad.addColorStop(1, "#1a0804");
    ctx.fillStyle = grad;
    ctx.fillRect(p.x, p.y, p.w, p.h);

    ctx.strokeStyle = "#ff9933";
    ctx.lineWidth = 2;
    ctx.strokeRect(p.x, p.y, p.w, p.h);
  }

  // plateformes mobiles
  for (const m of lvl.mobiles) {
    ctx.fillStyle = "#884400";
    ctx.fillRect(m.x, m.y, m.w, m.h);
    ctx.strokeStyle = "#ffd966";
    ctx.strokeRect(m.x, m.y, m.w, m.h);
  }

  // dangers (pics)
  ctx.fillStyle = "#ff3300";
  for (const d of lvl.dangers) {
    const spikes = Math.max(3, Math.floor(d.w / 12));
    const spikeW = d.w / spikes;
    for (let i = 0; i < spikes; i++) {
      const sx = d.x + i * spikeW;
      ctx.beginPath();
      ctx.moveTo(sx, d.y + d.h);
      ctx.lineTo(sx + spikeW / 2, d.y);
      ctx.lineTo(sx + spikeW, d.y + d.h);
      ctx.closePath();
      ctx.fill();
    }
  }

  // lave
  for (const l of lvl.lava) {
    const grad = ctx.createLinearGradient(l.x, l.y, l.x, l.y + l.h);
    grad.addColorStop(0, "#ffdd55");
    grad.addColorStop(0.3, "#ff5500");
    grad.addColorStop(1, "#550000");
    ctx.fillStyle = grad;
    ctx.fillRect(l.x, l.y, l.w, l.h);
  }

  // particules lave
  for (const p of particles) {
    const alpha = Math.max(0, p.life / 50);
    ctx.fillStyle = `rgba(255,200,80,${alpha})`;
    ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
  }

  // goal
  const g = lvl.goal;
  const gg = ctx.createLinearGradient(g.x, g.y, g.x, g.y + g.h);
  gg.addColorStop(0, "#ffffaa");
  gg.addColorStop(1, "#ffaa00");
  ctx.fillStyle = gg;
  ctx.fillRect(g.x, g.y, g.w, g.h);
  ctx.fillStyle = "#000";
  ctx.font = "bold 16px Arial";
  ctx.fillText("FIN", g.x + 4, g.y + g.h - 6);

  // player
  drawPlayer(player);

  ctx.restore();

  // transition overlay
  if (transition.active) {
    ctx.fillStyle = `rgba(0,0,0,${transition.alpha})`;
    ctx.fillRect(0, 0, W, H);
  }
}

function drawPlayer(p) {
  const bob = Math.sin(p.animTime * 2) * 2;
  ctx.save();
  ctx.translate(p.x + p.w / 2, p.y + p.h / 2 + bob);
  ctx.scale(p.facing, 1);

  // corps
  const grad = ctx.createLinearGradient(-16, -24, 16, 24);
  grad.addColorStop(0, "#00cfff");
  grad.addColorStop(1, "#005577");
  ctx.fillStyle = grad;
  ctx.fillRect(-16, -24, 32, 48);

  // yeux
  ctx.fillStyle = "#fff";
  ctx.fillRect(-8, -12, 6, 6);
  ctx.fillRect(2, -12, 6, 6);
  ctx.fillStyle = "#000";
  ctx.fillRect(-6, -10, 2, 2);
  ctx.fillRect(4, -10, 2, 2);

  // casque
  ctx.fillStyle = "#222";
  ctx.fillRect(-18, -26, 36, 10);
  ctx.fillStyle = "#ffcc00";
  ctx.fillRect(-4, -28, 8, 4);

  // jambes
  ctx.fillStyle = "#002233";
  const step = Math.sin(p.animTime * 6) * 4;
  ctx.fillRect(-12, 10 + step, 8, 16);
  ctx.fillRect(4, 10 - step, 8, 16);

  ctx.restore();
}

// ==================
// LEVELS
// ==================

// Niveau 1 – Intro
addLevel({
  start: { x: 120, y: 380 },
  platforms: [
    { x: 0, y: 440, w: 400, h: 40 },
    { x: 420, y: 410, w: 180, h: 30 },
    { x: 650, y: 380, w: 160, h: 30 },
    { x: 860, y: 350, w: 200, h: 30 }
  ],
  mobiles: [],
  dangers: [],
  lava: [
    { x: -200, y: 480, w: 1500, h: 100 }
  ],
  goal: { x: 980, y: 310, w: 40, h: 60 }
});

// Niveau 2 – Pics & sauts
addLevel({
  start: { x: 80, y: 360 },
  platforms: [
    { x: 0, y: 420, w: 280, h: 40 },
    { x: 360, y: 380, w: 180, h: 30 },
    { x: 620, y: 360, w: 160, h: 30 },
    { x: 880, y: 330, w: 200, h: 30 }
  ],
  mobiles: [],
  dangers: [
    { x: 280, y: 400, w: 60, h: 20 },
    { x: 540, y: 400, w: 60, h: 20 }
  ],
  lava: [
    { x: -200, y: 460, w: 1500, h: 120 }
  ],
  goal: { x: 960, y: 290, w: 40, h: 60 }
});

// Niveau 3 – Plateformes mobiles
addLevel({
  start: { x: 80, y: 320 },
  platforms: [
    { x: 0, y: 420, w: 260, h: 40 },
    { x: 900, y: 320, w: 220, h: 40 }
  ],
  mobiles: [
    {
      x: 380, y: 360, w: 120, h: 20,
      baseX: 380, baseY: 360, axis: "y",
      range: 100, speed: 0.05, t: 0
    },
    {
      x: 650, y: 260, w: 120, h: 20,
      baseX: 650, baseY: 260, axis: "x",
      range: 140, speed: 0.04, t: Math.PI / 2
    }
  ],
  dangers: [
    { x: 260, y: 400, w: 70, h: 20 },
    { x: 760, y: 440, w: 80, h: 20 }
  ],
  lava: [
    { x: -200, y: 460, w: 1600, h: 120 }
  ],
  goal: { x: 1000, y: 280, w: 40, h: 60 }
});

// Niveau 4 – Plus long, plus chaud
addLevel({
  start: { x: 60, y: 360 },
  platforms: [
    { x: 0, y: 430, w: 300, h: 40 },
    { x: 380, y: 400, w: 160, h: 30 },
    { x: 620, y: 360, w: 160, h: 30 },
    { x: 860, y: 340, w: 140, h: 30 },
    { x: 1120, y: 320, w: 160, h: 30 }
  ],
  mobiles: [
    {
      x: 320, y: 310, w: 80, h: 18,
      baseX: 320, baseY: 310, axis: "y",
      range: 90, speed: 0.06, t: 0
    },
    {
      x: 780, y: 260, w: 80, h: 18,
      baseX: 780, baseY: 260, axis: "y",
      range: 110, speed: 0.05, t: 1
    }
  ],
  dangers: [
    { x: 300, y: 410, w: 60, h: 20 },
    { x: 540, y: 390, w: 60, h: 20 },
    { x: 1020, y: 360, w: 60, h: 20 }
  ],
  lava: [
    { x: -200, y: 470, w: 2000, h: 120 }
  ],
  goal: { x: 1180, y: 280, w: 40, h: 60 }
});

// ==================
// LOOP
// ==================
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

prevBtn.addEventListener("click", () => {
  if (currentLevel > 0) {
    startTransition(() => loadLevel(currentLevel - 1));
  }
});

nextBtn.addEventListener("click", () => {
  if (currentLevel < levels.length - 1) {
    startTransition(() => loadLevel(currentLevel + 1));
  }
});

// start
loadLevel(0);
loop();
</script>
</body>
</html>
